<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body {
      background: #0F0F12;
      color: white;
      font-family: sans-serif;
      padding: 20px;
      margin: 0;
    }
    .header {
      text-align: center;
      margin-bottom: 20px;
    }
    .photo {
      width: 120px;
      height: 120px;
      border-radius: 50%;
      background: #333;
      margin: 0 auto 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      cursor: pointer;
    }
    .photo img {
      width: 100%;
      border-radius: 50%;
    }
    input, textarea, select {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      background: #1E1E24;
      border: 1px solid #333;
      border-radius: 8px;
      color: white;
    }
    .btn {
      background: #FF2D75;
      color: white;
      border: none;
      padding: 14px;
      border-radius: 30px;
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
    .back-btn {
      background: #2A2A32 !important;
      margin-top: 0;
    }
    .interests {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
    }
    .interest-tag {
      background: #2A2A32;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="photo" id="photoPreview" onclick="document.getElementById('photoInput').click()">üë§</div>
    <input type="file" id="photoInput" accept="image/*" style="display:none;" onchange="uploadPhoto()">
    <h2>–ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å</h2>
  </div>

  <button class="btn back-btn" onclick="window.location='https://loveblr.onrender.com'">‚Üê –ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é</button>

  <input type="text" id="bio" placeholder="–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ (–¥–æ 200 —Å–∏–º–≤–æ–ª–æ–≤)">
  
  <select id="goal">
    <option value="">–¶–µ–ª—å –∑–Ω–∞–∫–æ–º—Å—Ç–≤–∞</option>
    <option value="chat">üí¨ –û–±—â–µ–Ω–∏–µ</option>
    <option value="relationship">‚ù§Ô∏è –û—Ç–Ω–æ—à–µ–Ω–∏—è</option>
    <option value="sex">üî• S#X</option>
    <option value="hobby">üéÆ –•–æ–±–±–∏</option>
  </select>

  <input type="number" id="height" placeholder="–†–æ—Å—Ç (—Å–º)">
  <input type="number" id="weight" placeholder="–í–µ—Å (–∫–≥)">

  <div>–ò–Ω—Ç–µ—Ä–µ—Å—ã (–≤—ã–±–µ—Ä–∏ –∏–ª–∏ –≤–≤–µ–¥–∏ —Å–≤–æ–∏):</div>
  <div class="interests" id="interestsContainer">
    <!-- –¢–µ–≥–∏ –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
  </div>
  <input type="text" id="newInterest" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–µ—Å (–Ω–∞–ø—Ä–∏–º–µ—Ä: –∫–∏–Ω–æ)">

  <button class="btn" onclick="saveProfile()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>

  <script>
    let userTgId = null;

    function init() {
      const user = window.Telegram.WebApp.initDataUnsafe?.user;
      if (!user) {
        alert("–û—Ç–∫—Ä–æ–π—Ç–µ –≤ Telegram!");
        return;
      }
      userTgId = user.id;

      fetch(`https://loveblr.onrender.com/api/user/${userTgId}`)
        .then(r => r.json())
        .then(data => {
          document.getElementById('bio').value = data.bio || '';
          document.getElementById('goal').value = data.goal || '';
          document.getElementById('height').value = data.height || '';
          document.getElementById('weight').value = data.weight || '';
          renderInterests(data.interests || []);
          if (data.photo_url) {
            document.getElementById('photoPreview').innerHTML = `<img src="${data.photo_url}">`;
          }
        })
        .catch(err => {
          console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:", err);
        });
    }

    function renderInterests(interests) {
      const container = document.getElementById('interestsContainer');
      container.innerHTML = '';
      interests.forEach(tag => {
        const el = document.createElement('div');
        el.className = 'interest-tag';
        el.textContent = tag;
        el.onclick = () => removeInterest(tag);
        container.appendChild(el);
      });
    }

    function removeInterest(tagToRemove) {
      const input = document.getElementById('newInterest');
      const current = input.value.trim();
      input.value = current ? `${current}, ${tagToRemove}` : tagToRemove;
      const container = document.getElementById('interestsContainer');
      const tags = Array.from(container.children)
        .map(el => el.textContent)
        .filter(t => t !== tagToRemove);
      renderInterests(tags);
    }

    document.getElementById('newInterest').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        addInterest();
      }
    });

    function addInterest() {
      const input = document.getElementById('newInterest');
      const value = input.value.trim().toLowerCase();
      if (value && !document.getElementById('interestsContainer').textContent.includes(value)) {
        const container = document.getElementById('interestsContainer');
        const el = document.createElement('div');
        el.className = 'interest-tag';
        el.textContent = value;
        container.appendChild(el);
        input.value = '';
      }
    }

    function uploadPhoto() {
      const fileInput = document.getElementById('photoInput');
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('file', file);
      formData.append('tg_id', userTgId);

      fetch('https://loveblr.onrender.com/api/upload-photo', {
        method: 'POST',
        body: formData
      })
      .then(r => r.json())
      .then(data => {
        document.getElementById('photoPreview').innerHTML = `<img src="${data.photo_url}">`;
      })
      .catch(err => {
        alert("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ");
        console.error(err);
      });
    }

    function saveProfile() {
      const interests = Array.from(document.querySelectorAll('.interest-tag')).map(el => el.textContent);
      const data = {
        tg_id: userTgId,
        bio: document.getElementById('bio').value,
        goal: document.getElementById('goal').value,
        height: parseInt(document.getElementById('height').value) || null,
        weight: parseInt(document.getElementById('weight').value) || null,
        interests: interests
      };

      fetch('https://loveblr.onrender.com/api/profile', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      })
      .then(r => r.json())
      .then(res => {
        if (res.status === "ok") {
          alert("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω!");
          setTimeout(() => {
            window.location.href = 'https://loveblr.onrender.com';
          }, 1500);
        }
      })
      .catch(err => {
        alert("‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è");
        console.error(err);
      });
    }

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();
    init();
  </script>
</body>
</html>
